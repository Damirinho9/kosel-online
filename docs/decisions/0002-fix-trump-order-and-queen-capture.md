# ADR-0002: Исправление порядка козырей и логики поимки дамы

**Дата:** 2025-11-24
**Статус:** Принято ✓
**Контекст:** V2.0 - Критические ошибки в реализации правил игры

## Контекст и проблема

Пользователь сообщил о множественных ошибках AI помощника:
- Неверно оценивает ситуацию
- Ошибается в козырях и их старшинстве
- Предлагает сбросить, когда можно побить
- ML как будто не работает

После анализа обнаружены **критические ошибки** в реализации правил игры, полностью нарушающие логику игры в Козла.

---

## Проблема 1: КРИТИЧЕСКАЯ - Порядок козырей полностью неверный

### Правила по официальному гайду:

**Козыри по старшинству (от младшего к старшему):**
```
8♣, 9♣, K♣, 10♣, A♣, J♦, J♥, J♠, J♣, Q♦, Q♥, Q♠, Q♣, 7♣
```

**Ключевые факты:**
- **8♣ - САМЫЙ МЛАДШИЙ** козырь (среди трефовых)
- **7♣ - САМЫЙ СТАРШИЙ** козырь (бьёт всё!)

### Реализация ДО исправления (ai/card.js:51-66):

```javascript
const order = {
    '7_clubs': 0,       // 7♣ - самый младший ← НЕВЕРНО!
    'Q_clubs': 1,       // Q♣
    'Q_spades': 2,      // Q♠
    'Q_hearts': 3,      // Q♥
    'Q_diamonds': 4,    // Q♦
    'J_clubs': 5,       // J♣
    'J_spades': 6,      // J♠
    'J_hearts': 7,      // J♥
    'J_diamonds': 8,    // J♦
    'A_clubs': 9,       // A♣
    '10_clubs': 10,     // 10♣
    'K_clubs': 11,      // K♣
    '9_clubs': 12,      // 9♣
    '8_clubs': 13       // 8♣ - самый старший ← НЕВЕРНО!
};
```

**Порядок был полностью обратным!**

### Последствия ошибки:

1. **AI считал 7♣ самой слабой картой** → сбрасывал её первой
2. **AI считал 8♣ самой сильной** → пытался брать взятки 8♣
3. **Все стратегии с козырями работали наоборот:**
   - Пытался побить старшие козыри младшими
   - Сбрасывал сильные козыри в мусор
   - Держал слабые козыри для "важных" моментов
4. **ML обучался на неверных данных** → модель училась неправильной игре

---

## Проблема 2: КРИТИЧЕСКАЯ - Логика "поимки дамы" неверная

### Правила по гайду:

> "если дама треф и 7 треф легли в одну взятку от разных команд, кон немедленно заканчивается, и команда, положившая 7 треф, получает 4 очка"

**Ключевые требования:**
1. Q♣ и 7♣ должны быть в одной взятке
2. Они должны быть от **РАЗНЫХ КОМАНД**
3. Порядок не важен (кто первый положил)
4. Кон **немедленно завершается**

### Реализация ДО исправления (ai/rules.js:126-152):

```javascript
static checkQueenClubsCatch(tableCards) {
    // ...
    // Оба должны быть в взятке и 7♣ должна быть после Q♣
    return hasQueenClubs && hasSevenClubs && sevenClubsIndex > queenClubsIndex;
    //                                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    //                                      НЕВЕРНО: нет проверки команд!
}
```

**Ошибки:**
1. ❌ Нет проверки что Q♣ и 7♣ от **разных команд** (критично!)
2. ❌ Проверка `sevenClubsIndex > queenClubsIndex` неверна (порядок не важен)
3. ❌ Возврат `boolean` вместо информации о победившей команде
4. ❌ Функция не используется нигде (фича не интегрирована)

### Последствия ошибки:

1. **Поимка дамы не работала** (функция не вызывается)
2. **Если бы работала, считала бы поимкой даже одну команду** → нарушение правил
3. **AI не учитывал возможность поимки** в стратегиях

---

## Решение

### Исправление 1: Правильный порядок козырей

**Файл:** `kozel-assistant/ai/card.js:48-73`

```javascript
/**
 * ПРАВИЛЬНЫЙ порядок по гайду (от младшего к старшему):
 * 8♣, 9♣, K♣, 10♣, A♣, J♦, J♥, J♠, J♣, Q♦, Q♥, Q♠, Q♣, 7♣
 */
getTrumpOrder() {
    if (!this.isTrump()) {
        return -1;
    }

    const order = {
        '8_clubs': 0,       // 8♣ - самый младший трефовый козырь
        '9_clubs': 1,       // 9♣
        'K_clubs': 2,       // K♣
        '10_clubs': 3,      // 10♣
        'A_clubs': 4,       // A♣
        'J_diamonds': 5,    // J♦
        'J_hearts': 6,      // J♥
        'J_spades': 7,      // J♠
        'J_clubs': 8,       // J♣
        'Q_diamonds': 9,    // Q♦
        'Q_hearts': 10,     // Q♥
        'Q_spades': 11,     // Q♠
        'Q_clubs': 12,      // Q♣
        '7_clubs': 13       // 7♣ - САМЫЙ СТАРШИЙ КОЗЫРЬ!
    };

    const key = `${this.rank}_${this.suit}`;
    return order[key] !== undefined ? order[key] : -1;
}
```

**Изменения:**
- ✅ 7♣ теперь имеет order: 13 (самый старший)
- ✅ 8♣ теперь имеет order: 0 (самый младший трефовый)
- ✅ Все козыри расположены по правильному старшинству
- ✅ Добавлен комментарий с правилами

---

### Исправление 2: Правильная логика поимки дамы

**Файл:** `kozel-assistant/ai/rules.js:122-168`

```javascript
/**
 * Проверить поимку дамы треф
 * По правилам: "если дама треф и 7 треф легли в одну взятку от разных команд,
 * кон немедленно заканчивается, и команда, положившая 7 треф, получает 4 очка"
 *
 * @returns {Object|null} { caught: true, winningTeam: 'team1'/'team2' } или null
 */
static checkQueenClubsCatch(tableCards) {
    if (!tableCards || tableCards.length < 2) {
        return null;
    }

    let queenClubsPlayer = null;
    let sevenClubsPlayer = null;

    for (const {player, card} of tableCards) {
        if (card.rank === 'Q' && card.suit === 'clubs') {
            queenClubsPlayer = player;
        }

        if (card.rank === '7' && card.suit === 'clubs') {
            sevenClubsPlayer = player;
        }
    }

    // Оба должны быть в взятке
    if (!queenClubsPlayer || !sevenClubsPlayer) {
        return null;
    }

    // Проверяем что они от РАЗНЫХ КОМАНД
    // Команды: bottom-top (team1) vs left-right (team2)
    const queenTeam = (queenClubsPlayer === 'bottom' || queenClubsPlayer === 'top') ? 'team1' : 'team2';
    const sevenTeam = (sevenClubsPlayer === 'bottom' || sevenClubsPlayer === 'top') ? 'team1' : 'team2';

    if (queenTeam === sevenTeam) {
        // Одна команда - поимки нет
        return null;
    }

    // Поимка! Команда с 7♣ получает 4 очка
    return {
        caught: true,
        winningTeam: sevenTeam,
        winningPlayer: sevenClubsPlayer
    };
}
```

**Изменения:**
- ✅ Проверка что Q♣ и 7♣ от **разных команд** (критично!)
- ✅ Убрана неверная проверка порядка
- ✅ Возврат структурированного объекта с информацией о победителе
- ✅ Возврат `null` если поимки нет (вместо `false`)

**Команды в игре:**
- **team1:** bottom (пользователь) + top (партнёр)
- **team2:** left (оппонент 1) + right (оппонент 2)

---

## Последствия исправлений

### Положительные:

1. **AI теперь правильно оценивает силу козырей**
   - 7♣ используется для важных взяток (самая сильная карта)
   - 8♣-9♣ сбрасываются первыми (слабые козыри)
   - Стратегии атаки/защиты работают корректно

2. **ML будет обучаться правильно**
   - Энкодер получает правильные веса карт
   - Модель учится на корректных оценках ситуаций
   - Предыдущие обученные модели **невалидны** (нужно переобучить)

3. **Поимка дамы готова к интеграции**
   - Логика корректна
   - Можно интегрировать в content.js / strategy.js
   - Готова для V2.1

### Отрицательные:

1. **Все ранее обученные ML модели некорректны**
   - Обучены на неверном порядке козырей
   - Нужно очистить IndexedDB и переобучить с нуля

2. **Breaking change для пользователей**
   - Если пользователь уже сыграл 50+ игр и обучил модель
   - Нужно переобучить заново

---

## Рекомендации для пользователей

### Критично - очистить старую ML модель:

```javascript
// В консоли браузера (F12):
const request = indexedDB.deleteDatabase('tensorflowjs');
request.onsuccess = () => {
    console.log('ML модель очищена. Перезагрузите страницу.');
    location.reload();
};
```

### Затем:
1. Перезагрузить расширение в `chrome://extensions/`
2. Сыграть 5-10 игр для нового обучения ML
3. Проверить что рекомендации теперь корректны

---

## Верификация исправлений

### Тестовые случаи для порядка козырей:

```javascript
// Тест 1: 7♣ должна бить Q♣
const sevenClubs = new Card('7', 'clubs');
const queenClubs = new Card('Q', 'clubs');
assert(sevenClubs.compareInTrick(queenClubs, null) > 0); // ✅

// Тест 2: Q♣ должна бить J♣
const jackClubs = new Card('J', 'clubs');
assert(queenClubs.compareInTrick(jackClubs, null) > 0); // ✅

// Тест 3: 8♣ - самый слабый трефовый козырь
const eightClubs = new Card('8', 'clubs');
const nineClubs = new Card('9', 'clubs');
assert(nineClubs.compareInTrick(eightClubs, null) > 0); // ✅
```

### Тестовые случаи для поимки дамы:

```javascript
// Тест 1: Q♣ от team1, 7♣ от team2 = поимка
const tableCards = [
    {player: 'bottom', card: new Card('Q', 'clubs')},
    {player: 'left', card: new Card('7', 'clubs')}
];
const result = KozelRules.checkQueenClubsCatch(tableCards);
assert(result.caught === true); // ✅
assert(result.winningTeam === 'team2'); // ✅

// Тест 2: Q♣ и 7♣ от одной команды = НЕТ поимки
const tableCards2 = [
    {player: 'bottom', card: new Card('Q', 'clubs')},
    {player: 'top', card: new Card('7', 'clubs')}  // partner
];
const result2 = KozelRules.checkQueenClubsCatch(tableCards2);
assert(result2 === null); // ✅
```

---

## Риски

### Риск 1: ML модели пользователей некорректны

**Вероятность:** 100% (если пользователь уже играл)

**Митигация:**
- Добавить в CHANGELOG предупреждение об очистке модели
- Добавить version check в ml-model.js
- Auto-detect старая модель → автоматическая очистка (V2.1)

### Риск 2: Изменение возвращаемого типа checkQueenClubsCatch

**Вероятность:** Низкая (функция не используется)

**Митигация:**
- Функция пока не интегрирована → breaking change безопасен
- Обновить документацию перед интеграцией

---

## Связанные документы

- [Architecture: AI Card System](../architecture.md#ai-card-system)
- [AI Coding Rules: Критичные зоны](../ai-coding.md#особо-осторожные-зоны)
- [Troubleshooting: ML не работает](../runbooks/troubleshooting.md#ml-не-работает)

---

## История изменений

| Дата       | Версия | Изменение                           |
|------------|--------|-------------------------------------|
| 2025-11-24 | 1.0    | Первая версия ADR (исправления) |

---

**Автор:** AI Dev Agent (Claude)
**Ревьюер:** Пользователь (баг-репорт)
**Приоритет:** CRITICAL
**Теги:** #bugfix #game-rules #trump-order #queen-capture
